---
name: "LAB - Patroni Cluster No Primary"
type: "metric alert"
query: "max(last_5m):sum:patroni.patroni_primary{env:staging} by {host} < 1"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 1
  notify_no_data: true
  no_data_timeframe: 5
  renotify_interval: 10

---
name: "LAB - Patroni Cluster Split-Brain"
type: "metric alert"
query: "max(last_5m):sum:patroni.patroni_primary{env:staging} by {host} > 1"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 1
  notify_no_data: true
  no_data_timeframe: 5
  renotify_interval: 10

---
name: "LAB - Patroni Cluster Insufficient HA"
type: "metric alert"
query: "max(last_10m):sum:patroni.patroni_replica{env:staging} by {host} < 1"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 1
  notify_no_data: true
  no_data_timeframe: 10
  renotify_interval: 30

---
name: "LAB - Patroni Cluster Node Down"
type: "metric alert"
query: "max(last_5m):sum:patroni.patroni_postgres_running{env:staging} by {host,scope} < 1"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 1
  notify_no_data: true
  no_data_timeframe: 5
  renotify_interval: 15

---
name: "LAB - Patroni Cluster Auto-Failover Off"
type: "metric alert"
query: "max(last_10m):sum:patroni.patroni_cluster_unlocked{env:staging} by {host,scope} > 0"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 0
  notify_no_data: true
  no_data_timeframe: 5
  renotify_interval: 15


---
name: "LAB - Patroni Cluster Paused"
type: "metric alert"
query: "max(last_10m):max:patroni.patroni_is_paused{env:staging} by {scope} > 0"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 0
  notify_no_data: true
  no_data_timeframe: 15
  renotify_interval: 180


---
name: "LAB - Patroni Node Failsafe"
type: "metric alert"
query: "max(last_5m):max:patroni.patroni_failsafe_mode_is_active{env:staging} by {scope} > 0"
message: |
  Please investigate immediately.
tags:
  - "env:staging"
  - "service:patroni"
  - "serverity:critical"
options:
  thresholds:
    critical: 0
  notify_no_data: false
  no_data_timeframe: 10
  renotify_interval: 20
